<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="RashidZainol">
    <meta name="version" content="1.0.1">
    <title>OmniAudit GL.io v1.0.1 (Smart Review Fix)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* --- CORE STYLES --- */
        body { background-color: #f0f4f8; font-family: 'Segoe UI', sans-serif; user-select: none; color: #1e293b; }
        .gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #2563eb 100%); }
        .glass-panel { background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        
        /* HEADERS & FILTERS */
        thead { position: sticky; top: 0; z-index: 20; background: #f8fafc; }
        th.sort-header { 
            background: #f1f5f9; color: #475569; font-size: 0.75rem; text-transform: uppercase; 
            letter-spacing: 0.05em; padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #e2e8f0;
            white-space: nowrap; transition: background 0.2s; border-right: 1px solid #e2e8f0;
        }
        th.sort-header:hover { background: #e2e8f0; color: #0f172a; }
        .column-filter { width: 100%; padding: 4px 8px; font-size: 0.75rem; border: 1px solid #cbd5e1; border-radius: 4px; background: white; color: #334155; margin-top: 0; font-weight: normal; }
        .column-filter:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pop-in { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .row-selected { background-color: #eff6ff !important; border-left: 4px solid #3b82f6; }
        
        /* TOAST & OVERLAYS */
        #saveToast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; font-size: 0.85rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 80; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        #saveToast.show { opacity: 1; transform: translateY(-5px); }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 60; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 600px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }

        /* BUTTONS */
        .btn-pro { background: linear-gradient(to right, #2563eb, #4f46e5); color: white; transition: 0.2s; }
        .btn-pro:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-green { background: linear-gradient(to right, #059669, #10b981); color: white; transition: 0.2s; }
        .btn-green:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .icon-btn { padding: 6px; border-radius: 6px; transition: all 0.2s; }
        .icon-btn:hover { background-color: #f1f5f9; transform: scale(1.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" oncontextmenu="return false;">

    <div id="loadingOverlay">
        <div class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full spin mb-4"></div>
        <h1 class="text-xl font-bold tracking-tight flex items-center gap-2">
    OmniAudit GL.io 
    <span class="bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold tracking-wide shadow-sm border border-blue-400">v1.0.1</span>
    <a id="updateBadge" href="https://github.com/rashidzainol/OmniAudit" target="_blank" class="hidden bg-rose-500 hover:bg-rose-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold tracking-wide shadow-lg cursor-pointer animate-pulse border border-rose-400 flex items-center gap-1 transition">
        <i data-lucide="arrow-up-circle" class="w-3 h-3"></i> Update!
    </a>
</h1>
        <p class="text-slate-500 font-mono text-xs mt-1">v1.0.1 - Smart Review</p>
    </div>

    <div id="saveToast"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-400"></i> <span id="toastMsg">Action Saved</span></div>

    <div id="reviewModal" class="modal-bg">
        <div class="modal-content pop-in" style="max-width: 900px; height: 85vh; display: flex; flex-direction: column;">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="list-checks" class="w-6 h-6 text-indigo-600"></i> Review Selection
                    </h3>
                    <p class="text-xs text-slate-500">Verify items before extraction.</p>
                </div>
                <div class="bg-indigo-50 px-3 py-1 rounded-full text-indigo-700 text-xs font-bold border border-indigo-100">
                    Selected: <span id="reviewCount">0</span>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar border rounded-lg bg-slate-50 mb-4">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 z-10" id="reviewTableHead">
                        </thead>
                    <tbody id="reviewTableBody" class="text-sm text-slate-600 divide-y divide-slate-200"></tbody>
                </table>
            </div>
            
            <div class="flex justify-between items-center pt-2">
                <button onclick="document.getElementById('reviewModal').style.display='none'" class="px-4 py-2 text-sm text-slate-500 hover:text-slate-800 font-medium">Back to Dashboard</button>
                <button onclick="proceedToExportConfig()" class="btn-green px-6 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg hover:shadow-xl">
                    Proceed to Export <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal-bg">
        <div class="modal-content pop-in">
            <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="download" class="w-5 h-5 text-indigo-600"></i> Export Settings</h3>
            <p class="text-sm text-slate-500 mb-4">Select columns to include.</p>
            <div class="flex justify-between items-center mb-2 px-1 border-b pb-2"><span class="text-xs font-bold text-slate-400 uppercase">Headers</span><div><button onclick="toggleExportCols(true)" class="text-xs text-indigo-600 hover:underline mr-3 font-bold">All</button><button onclick="toggleExportCols(false)" class="text-xs text-slate-500 hover:underline">Clear</button></div></div>
            <div id="exportColumnList" class="max-h-60 overflow-y-auto custom-scrollbar grid grid-cols-2 gap-2 p-1"></div>
            <div class="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100 flex items-start gap-3"><div class="bg-indigo-100 p-1 rounded text-indigo-600"><i data-lucide="info" class="w-4 h-4"></i></div><div><p class="text-xs font-bold text-indigo-800">Auto-Inclusion</p><p class="text-[10px] text-indigo-600">"Audit Note" column is always included.</p></div></div>
            <div class="flex justify-end gap-2 mt-6 border-t pt-4"><button onclick="document.getElementById('exportModal').style.display='none'" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Back</button><button onclick="runExport()" class="btn-pro px-6 py-2 rounded-lg text-sm font-bold flex items-center gap-2">Download .XLSX <i data-lucide="file-check"></i></button></div>
        </div>
    </div>

    <div id="noteModal" class="modal-bg">
        <div class="modal-content pop-in">
            <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="message-square-plus" class="w-5 h-5 text-indigo-600"></i> Audit Note</h3>
            <textarea id="noteInputArea" class="w-full p-4 border border-slate-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-40 resize-none bg-slate-50 focus:bg-white transition" placeholder="Type your observation here..."></textarea>
            <div class="flex justify-end gap-2 mt-4"><button onclick="closeNoteModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button><button onclick="saveModalNote()" class="btn-pro px-6 py-2 rounded-lg text-sm font-bold">Save Note</button></div>
        </div>
    </div>

    <div id="columnModal" class="modal-bg">
        <div class="modal-content pop-in">
            <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><i data-lucide="layout" class="w-5 h-5 text-indigo-600"></i> Manage Columns</h3>
            <p class="text-xs text-slate-500 mb-4">Tick columns to display.</p>
            <div class="flex justify-between items-center mb-2 px-1"><span class="text-xs font-bold text-slate-400 uppercase">Available Headers</span><button onclick="toggleAllCols(true)" class="text-xs text-indigo-600 hover:underline">Select All</button></div>
            <div id="columnToggleList" class="max-h-60 overflow-y-auto custom-scrollbar grid grid-cols-2 gap-2 p-1"></div>
            <div class="flex justify-end gap-2 mt-6 border-t pt-4"><button onclick="document.getElementById('columnModal').style.display='none'" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Close</button><button onclick="applyColumnChanges()" class="btn-pro px-6 py-2 rounded-lg text-sm font-bold">Apply View</button></div>
        </div>
    </div>

    <header class="gradient-header text-white px-6 py-4 shadow-lg flex justify-between items-center z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/10"><i data-lucide="shield-check" class="w-6 h-6 text-white"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight flex items-center gap-2">OmniAudit GL.io <span class="bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold tracking-wide shadow-sm border border-blue-400">v1.4.0</span></h1>
                <p class="text-xs text-blue-100 opacity-80 font-medium tracking-wide">Drill-down & Smart Review</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <span id="fileInfo" class="hidden md:block text-xs font-mono bg-black/20 px-3 py-1 rounded-full text-blue-50 border border-white/10">No File</span>
            <button onclick="location.reload()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2 border border-white/20"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Reset</button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative bg-slate-50">
        
        <div id="uploadSection" class="h-full flex flex-col items-center justify-center p-8 fade-in">
            <div class="glass-panel p-16 border-2 border-dashed border-indigo-200 hover:border-indigo-500 hover:bg-indigo-50/30 transition-all cursor-pointer group relative text-center max-w-2xl w-full">
                <input type="file" id="inputFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".csv, .xlsx, .xls">
                <div class="bg-indigo-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-sm"><i data-lucide="upload-cloud" class="w-12 h-12 text-indigo-600"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 mb-3">Upload General Ledger</h2>
                <p class="text-slate-500 text-lg">Drag & drop .XLSX or .CSV file here</p>
                <p class="text-xs text-slate-400 mt-8 font-mono">100% Client-Side Processing</p>
            </div>
        </div>

        <div id="configSection" class="hidden h-full flex flex-col items-center justify-center p-6 fade-in">
            <div class="glass-panel w-full max-w-5xl p-10 shadow-xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                <div class="flex items-center gap-4 mb-8 pb-4 border-b">
                    <div class="bg-indigo-600 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg shadow-lg">2</div>
                    <h2 class="text-2xl font-bold text-slate-800">Map Financial Columns</h2>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Debit Column</label><div class="relative"><select id="mapDebit" class="w-full p-3.5 border rounded-xl bg-white text-sm appearance-none font-semibold text-slate-700 shadow-sm"></select><i data-lucide="chevron-down" class="absolute right-3 top-4 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Credit Column</label><div class="relative"><select id="mapCredit" class="w-full p-3.5 border rounded-xl bg-white text-sm appearance-none font-semibold text-slate-700 shadow-sm"></select><i data-lucide="chevron-down" class="absolute right-3 top-4 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Balance (Opt)</label><div class="relative"><select id="mapBalance" class="w-full p-3.5 border rounded-xl bg-white text-sm appearance-none font-semibold text-slate-700 shadow-sm"></select><i data-lucide="chevron-down" class="absolute right-3 top-4 w-4 h-4 text-slate-400 pointer-events-none"></i></div></div>
                    </div>
                </div>
                <div class="mb-6"><div class="flex justify-between items-center mb-3"><label class="block text-xs font-bold uppercase text-slate-500">Select Initial View Columns</label><button onclick="toggleConfigCols(true)" class="text-xs text-indigo-600 hover:underline font-bold">Select All</button></div><div id="configColumnList" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div></div>
                <div class="flex justify-end border-t pt-6"><button onclick="processConfig()" class="btn-pro px-8 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg transform transition hover:scale-105">Launch Dashboard <i data-lucide="layout-dashboard" class="w-4 h-4"></i></button></div>
            </div>
        </div>

        <div id="dashboardSection" class="hidden h-full flex flex-col fade-in">
            <div class="bg-white border-b border-slate-200 p-4 grid grid-cols-2 md:grid-cols-4 gap-4 shrink-0 shadow-sm z-10">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 flex flex-col items-center justify-center"><span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Total Rows</span><span id="statRows" class="text-slate-800 font-extrabold text-2xl mt-1">0</span></div>
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex flex-col items-center justify-center"><span class="text-[10px] uppercase font-bold text-indigo-400 tracking-wider">Total Debit</span><span id="statDebit" class="text-indigo-700 font-extrabold text-xl mt-1">0.00</span></div>
                <div class="bg-rose-50 p-4 rounded-xl border border-rose-100 flex flex-col items-center justify-center"><span class="text-[10px] uppercase font-bold text-rose-400 tracking-wider">Total Credit</span><span id="statCredit" class="text-rose-700 font-extrabold text-xl mt-1">0.00</span></div>
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex flex-col items-center justify-center"><span class="text-[10px] uppercase font-bold text-emerald-400 tracking-wider">Net Variance</span><span id="statNet" class="text-emerald-700 font-extrabold text-xl mt-1">0.00</span></div>
            </div>

            <div class="bg-white border-b border-slate-200 px-4 py-3 flex gap-3 items-center justify-between shrink-0 z-10">
                <div class="flex items-center gap-2 flex-1">
                    <button onclick="openColumnModal()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 p-2.5 rounded-lg border border-slate-200 transition shadow-sm" title="Add/Remove Columns"><i data-lucide="layout" class="w-5 h-5"></i></button>
                    <div class="relative w-full max-w-sm"><i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i><input type="text" id="searchInput" placeholder="Global search..." class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500 shadow-sm transition" onkeyup="filterData()"></div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="openReviewModal()" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-4 py-2.5 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm transition hover:border-indigo-300"><i data-lucide="list-checks" class="w-4 h-4 text-indigo-500"></i> Extract Selected</button>
                    <button onclick="triggerFullReport()" class="btn-success px-5 py-2.5 rounded-lg text-xs font-bold flex items-center gap-2 shadow-md transform transition hover:scale-105 active:scale-95"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Full Report</button>
                </div>
            </div>

            <div class="flex-1 overflow-auto custom-scrollbar bg-white relative">
                <table class="w-full text-left border-collapse">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody" class="text-sm text-slate-600 divide-y divide-slate-100"></tbody>
                </table>
            </div>
            
            <div class="bg-white border-t border-slate-200 p-2 text-[10px] text-center text-slate-400 font-mono">
                Powered by RashidZainol &bull; v1.4.0
            </div>
        </div>
    </main>

    <script>
        // --- INIT ---
        document.onkeydown = function(e) { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0))) return false; }
        console.log("%c OmniAudit GL.io \n%c v1.4.0 ", "background: #1e3a8a; color: #fff; font-size: 16px; padding: 8px;", "color: #1e3a8a; font-size: 12px;");
        lucide.createIcons();

        // --- VARS ---
        let rawData = [], auditData = [], filteredData = [], headers = [];
        let visibleColumns = [], colDebit = "", colCredit = "", colBalance = "";
        let currentExportType = 'full', currentFileName = "Audit_Data";
        let activeNoteId = null;
        let sortCol = null, sortAsc = true;
        let columnFilters = {}; 

        // 1. FILE
        document.getElementById('inputFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            currentFileName = file.name.split('.')[0];
            document.getElementById('fileInfo').innerText = file.name;
            document.getElementById('loadingOverlay').style.display = 'flex';
            setTimeout(() => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const wb = XLSX.read(data, {type: 'array', cellDates: true});
                        rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:""});
                        if(rawData.length === 0) throw new Error("Empty file");
                        headers = Object.keys(rawData[0]);
                        populateSelect('mapDebit', headers, ['debit','dr','amount']);
                        populateSelect('mapCredit', headers, ['credit','cr']);
                        populateSelect('mapBalance', headers, ['balance','bal']);
                        populateConfigColumns(headers);
                        populateColumnManager(headers);
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('uploadSection').classList.add('hidden');
                        document.getElementById('configSection').classList.remove('hidden');
                    } catch(err) { alert(err.message); document.getElementById('loadingOverlay').style.display='none'; }
                };
                reader.readAsArrayBuffer(file);
            }, 100);
        });

        // 2. CONFIG
        function populateSelect(id, cols, keywords) {
            const sel = document.getElementById(id);
            sel.innerHTML = '<option value="">-- None --</option>';
            let best = "";
            cols.forEach(c => {
                sel.innerHTML += `<option value="${c}">${c}</option>`;
                if(!best && keywords.some(k => c.toLowerCase().includes(k))) best = c;
            });
            if(best) sel.value = best;
        }
        function populateConfigColumns(cols) {
            const div = document.getElementById('configColumnList');
            div.innerHTML = "";
            cols.forEach(c => {
                const checked = ['date','ref','desc','keterangan','particular','payee'].some(k=>c.toLowerCase().includes(k));
                div.innerHTML += `<label class="flex items-center gap-2 p-2.5 bg-slate-50 border border-slate-100 rounded-lg cursor-pointer"><input type="checkbox" value="${c}" class="config-col-check accent-indigo-600 w-4 h-4 rounded" ${checked?'checked':''}><span class="text-xs font-semibold text-slate-700 truncate" title="${c}">${c}</span></label>`;
            });
        }
        function toggleConfigCols(st) { document.querySelectorAll('.config-col-check').forEach(c => c.checked = st); }
        function processConfig() {
            colDebit = document.getElementById('mapDebit').value;
            colCredit = document.getElementById('mapCredit').value;
            colBalance = document.getElementById('mapBalance').value;
            visibleColumns = Array.from(document.querySelectorAll('.config-col-check:checked')).map(c => c.value);
            if(visibleColumns.length === 0) return alert("Select at least one column.");
            document.getElementById('loadingOverlay').style.display = 'flex';
            setTimeout(() => {
                auditData = rawData.map((row, i) => {
                    let dr = 0, cr = 0;
                    if(colDebit) dr = parseFloat(String(row[colDebit]).replace(/[^0-9.-]/g,'')) || 0;
                    if(colCredit) {
                        let cStr = String(row[colCredit]);
                        cr = parseFloat(cStr.replace(/[^0-9.-]/g,'')) || 0;
                        if(cStr.includes('(')) cr = Math.abs(cr);
                    }
                    return { id: i, debit: dr, credit: cr, raw: row, selected: false, note: "" };
                });
                renderHeaders(); 
                filterData();
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('configSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
                lucide.createIcons();
            }, 50);
        }

        // 3. UI
        function updateColumnFilter(col, val) {
            if (val === "") delete columnFilters[col];
            else columnFilters[col] = val.toLowerCase();
            filterData();
        }

        function filterData() {
            const globalTxt = document.getElementById('searchInput').value.toLowerCase();
            filteredData = auditData.filter(d => {
                if (globalTxt && !Object.values(d.raw).join(" ").toLowerCase().includes(globalTxt)) return false;
                for (let col in columnFilters) {
                    let cellVal = d.raw[col];
                    if (cellVal instanceof Date) cellVal = cellVal.toLocaleDateString();
                    else cellVal = String(cellVal || "");
                    if (!cellVal.toLowerCase().includes(columnFilters[col])) return false;
                }
                return true;
            });
            if (sortCol) {
                filteredData.sort((a, b) => {
                    let valA = a.raw[sortCol] || "";
                    let valB = b.raw[sortCol] || "";
                    if (valA instanceof Date && valB instanceof Date) return sortAsc ? valA - valB : valB - valA;
                    if (typeof valA === 'number' && typeof valB === 'number') return sortAsc ? valA - valB : valB - valA;
                    return sortAsc ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
                });
            }
            renderBody();
            updateStats();
        }

        function sortData(col) {
            if (sortCol === col) sortAsc = !sortAsc;
            else { sortCol = col; sortAsc = true; }
            filterData(); renderHeaders(); 
        }

        function renderHeaders() {
            const isAllSelected = filteredData.length > 0 && filteredData.every(d => d.selected);
            const thead = document.getElementById('tableHead');
            let topRow = `<tr><th class="px-4 py-3 w-12 text-center border-r border-slate-200 bg-slate-50"><input type="checkbox" id="selectAll" class="accent-indigo-600 w-4 h-4 cursor-pointer" ${isAllSelected?'checked':''} onchange="toggleSelectAll(this.checked)"></th>`;
            let filterRow = `<tr><th class="bg-slate-50 border-r border-slate-200"></th>`;
            visibleColumns.forEach(c => {
                let cls = "";
                if(c===colDebit) cls="bg-indigo-50 text-indigo-700";
                if(c===colCredit) cls="bg-rose-50 text-rose-700";
                if(c===colBalance) cls="bg-emerald-50 text-emerald-700";
                let sortIcon = sortCol === c ? (sortAsc ? " ⬆" : " ⬇") : "";
                topRow += `<th class="sort-header border-r border-slate-100 ${cls}" onclick="sortData('${c}')">${c}${sortIcon}</th>`;
                let currentVal = columnFilters[c] || "";
                filterRow += `<th class="bg-f8fafc border-r border-slate-100 p-1"><input type="text" class="column-filter" placeholder="Filter..." value="${currentVal}" onkeyup="updateColumnFilter('${c}', this.value)" onclick="event.stopPropagation()"></th>`;
            });
            topRow += `<th class="px-4 py-3 w-20 text-center bg-slate-50 border-l border-slate-200">Note</th></tr>`;
            filterRow += `<th class="bg-slate-50 border-l border-slate-200"></th></tr>`;
            thead.innerHTML = topRow + filterRow;
        }

        function renderBody() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            const limit = 200;
            const subset = filteredData.slice(0, limit);
            let bHTML = "";
            subset.forEach(d => {
                const rowCls = d.selected ? 'row-selected' : 'hover:bg-slate-50';
                const hasNote = d.note && d.note.trim() !== "";
                const iconColor = hasNote ? "text-indigo-600 fill-indigo-100" : "text-slate-400 hover:text-indigo-500";
                bHTML += `<tr class="${rowCls} border-b border-slate-50 transition" id="tr-${d.id}">
                    <td class="px-4 py-3 text-center border-r border-slate-50"><input type="checkbox" class="accent-indigo-600 w-4 h-4 cursor-pointer" ${d.selected?'checked':''} onchange="toggleRow(${d.id})"></td>`;
                visibleColumns.forEach(c => {
                    let val = d.raw[c], cls="text-slate-600";
                    if(val instanceof Date) val = val.toLocaleDateString();
                    else if(typeof val === 'number') val = val.toLocaleString('en-MY', {minimumFractionDigits:2});
                    if(c===colDebit) cls="font-bold text-indigo-700 font-mono text-right";
                    if(c===colCredit) cls="font-bold text-rose-700 font-mono text-right";
                    if(c===colBalance) cls="font-bold text-emerald-700 font-mono text-right";
                    bHTML += `<td class="px-6 py-3 text-sm border-r border-slate-50 whitespace-nowrap max-w-xs truncate ${cls}" title="${d.raw[c]}">${val||'-'}</td>`;
                });
                bHTML += `<td class="px-4 py-2 text-center bg-slate-50 border-l border-slate-50"><button onclick="openNoteModal(${d.id})" class="icon-btn ${iconColor}"><i data-lucide="plus-circle" class="w-5 h-5 ${hasNote?'fill-indigo-100':''}"></i></button></td></tr>`;
            });
            if(filteredData.length > limit) bHTML += `<tr><td colspan="${visibleColumns.length+2}" class="p-4 text-center text-xs text-slate-400 italic">Showing first ${limit} rows.</td></tr>`;
            tbody.innerHTML = bHTML;
            lucide.createIcons();
        }

        function updateStats() {
            document.getElementById('statRows').innerText = filteredData.length.toLocaleString();
            let dr=0, cr=0;
            filteredData.forEach(d => { dr+=d.debit; cr+=d.credit; });
            document.getElementById('statDebit').innerText = dr.toLocaleString('en-MY', {minimumFractionDigits:2});
            document.getElementById('statCredit').innerText = cr.toLocaleString('en-MY', {minimumFractionDigits:2});
            document.getElementById('statNet').innerText = (dr-cr).toLocaleString('en-MY', {minimumFractionDigits:2});
        }

        // 4. ACTIONS
        function toggleRow(id) { const i = auditData.findIndex(x => x.id === id); if(i>-1) { auditData[i].selected = !auditData[i].selected; renderBody(); } }
        function toggleSelectAll(isChecked) { filteredData.forEach(d => { const i = auditData.findIndex(x => x.id === d.id); if(i>-1) auditData[i].selected = isChecked; }); renderBody(); }

        // 5. EXTRACT & EXPORT (DYNAMIC REVIEW FIX)
        function openReviewModal() {
            const selected = auditData.filter(d => d.selected);
            if(selected.length === 0) return alert("Select rows first.");
            
            document.getElementById('reviewCount').innerText = selected.length;
            const thead = document.getElementById('reviewTableHead');
            
            // Build Dynamic Review Headers (Action + First 3 Visible Cols + Net + Note)
            let headerHTML = `<tr><th class="px-4 py-2 w-10 text-center bg-white border-b">Remove</th>`;
            
            // Limit to 3 columns to keep modal clean
            const previewCols = visibleColumns.slice(0, 3);
            previewCols.forEach(c => {
                headerHTML += `<th class="px-4 py-2 w-32 bg-white border-b text-xs text-slate-500 uppercase">${c}</th>`;
            });
            headerHTML += `<th class="px-4 py-2 w-28 text-right bg-white border-b">Net Amt</th>`;
            headerHTML += `<th class="px-4 py-2 w-32 bg-white border-b">Note</th></tr>`;
            thead.innerHTML = headerHTML;

            // Build Body
            const tbody = document.getElementById('reviewTableBody');
            tbody.innerHTML = "";
            
            selected.forEach(d => {
                let rowHTML = `<tr class="bg-white border-b border-slate-100 hover:bg-slate-50">
                    <td class="px-4 py-2 text-center">
                        <button onclick="removeItem(${d.id})" class="text-rose-500 hover:bg-rose-50 p-1 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>`;
                
                previewCols.forEach(c => {
                    let val = d.raw[c];
                    if(val instanceof Date) val = val.toLocaleDateString();
                    rowHTML += `<td class="px-4 py-2 text-xs text-slate-700 truncate max-w-[150px]" title="${val}">${val||'-'}</td>`;
                });

                const amt = d.debit - d.credit;
                rowHTML += `<td class="px-4 py-2 font-mono text-right text-xs font-bold text-slate-700">${amt.toLocaleString('en-MY', {minimumFractionDigits:2})}</td>`;
                rowHTML += `<td class="px-4 py-2 text-xs italic text-slate-400 truncate max-w-[100px]">${d.note||''}</td></tr>`;
                
                tbody.innerHTML += rowHTML;
            });

            document.getElementById('reviewModal').style.display = 'flex';
            lucide.createIcons();
        }

        function removeItem(id) { const i = auditData.findIndex(x => x.id === id); if(i>-1) { auditData[i].selected = false; openReviewModal(); renderBody(); } }
        function triggerFullReport() { currentExportType = 'full'; openExportConfig(); }
        function proceedToExportConfig() { document.getElementById('reviewModal').style.display = 'none'; currentExportType = 'extract'; openExportConfig(); }
        
        function openExportConfig() {
            const div = document.getElementById('exportColumnList');
            div.innerHTML = "";
            headers.forEach(h => {
                const checked = visibleColumns.includes(h);
                div.innerHTML += `<label class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded cursor-pointer border border-slate-100"><input type="checkbox" value="${h}" class="export-col-check accent-indigo-600 w-4 h-4" ${checked?'checked':''}><span class="text-xs text-slate-700 truncate">${h}</span></label>`;
            });
            document.getElementById('exportModal').style.display = 'flex';
        }
        function toggleExportCols(st) { document.querySelectorAll('.export-col-check').forEach(c => c.checked = st); }
        function runExport() {
            const cols = Array.from(document.querySelectorAll('.export-col-check:checked')).map(c => c.value);
            if(cols.length === 0) return alert("Select columns.");
            const dataset = (currentExportType === 'extract') ? auditData.filter(d => d.selected) : filteredData;
            const ws = XLSX.utils.json_to_sheet(dataset.map(d => {
                let r = {};
                cols.forEach(c => r[c] = d.raw[c]);
                r['Audit Note'] = d.note;
                return r;
            }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, currentFileName + (currentExportType==='extract'?"_Extract":"_Report") + ".xlsx");
            document.getElementById('exportModal').style.display = 'none';
        }

        // 6. UTILS
        function openNoteModal(id) { activeNoteId = id; document.getElementById('noteInputArea').value = auditData.find(d=>d.id===id).note; document.getElementById('noteModal').style.display = 'flex'; document.getElementById('noteInputArea').focus(); }
        function closeNoteModal() { document.getElementById('noteModal').style.display = 'none'; activeNoteId = null; }
        function saveModalNote() { if(activeNoteId !== null) { auditData.find(d=>d.id===activeNoteId).note = document.getElementById('noteInputArea').value; document.getElementById('saveToast').classList.add('show'); setTimeout(()=>document.getElementById('saveToast').classList.remove('show'), 2000); renderBody(); } closeNoteModal(); }
        function populateColumnManager(cols) { const div = document.getElementById('columnToggleList'); div.innerHTML = ""; cols.forEach(c => div.innerHTML += `<label class="flex items-center gap-3 p-2 hover:bg-slate-50 border-b border-slate-50 last:border-0"><input type="checkbox" value="${c}" class="col-view-check accent-indigo-600 w-4 h-4 rounded"><span class="text-sm text-slate-600">${c}</span></label>`); }
        function openColumnModal() { document.querySelectorAll('.col-view-check').forEach(c => c.checked = visibleColumns.includes(c.value)); document.getElementById('columnModal').style.display = 'flex'; }
        function toggleAllCols(st) { document.querySelectorAll('.col-view-check').forEach(c => c.checked = st); }
        function applyColumnChanges() { visibleColumns = Array.from(document.querySelectorAll('.col-view-check:checked')).map(c => c.value); document.getElementById('columnModal').style.display = 'none'; renderHeaders(); renderBody(); updateStats(); }
    
	// --- AUTO UPDATE CHECKER ---
const CURRENT_VERSION = "1.0.1"; // Tukar ini bila anda release version baru
const GITHUB_USER = "rashidzainol"; // Username GitHub anda (Nanti kita create)
const REPO_NAME = "OmniAudit"; // Nama Repository anda
const VERSION_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO_NAME}/main/version.json`;

async function checkUpdate() {
    try {
        const response = await fetch(VERSION_URL);
        if (!response.ok) return; // Fail senyap kalau offline
        const data = await response.json();
        
        // Bandingkan version (Simple string comparison)
        if (data.version !== CURRENT_VERSION) {
            const badge = document.getElementById('updateBadge');
            badge.classList.remove('hidden');
            badge.href = data.download_url; // Link ke file baru
            badge.title = `New version ${data.version} available!`;
            console.log(`Update available: v${data.version}`);
        }
    } catch (error) {
        console.log("Offline mode: Update check skipped.");
    }
}

// Jalankan checker 2 saat selepas page load
setTimeout(checkUpdate, 2000);
	</script>
</body>
</html>